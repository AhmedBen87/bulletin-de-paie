<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Calculator - {{ profile.name }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #34495e;
            --light-bg: #f5f7fa;
            --dark-bg: #2c3e50;
            --text-color: #333;
            --light-text: #f5f7fa;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --border-radius: 6px;
            --box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: #f5f7fa;
            padding: 0;
            margin: 0;
            color: var(--text-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        header h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-top: 0.5rem;
            opacity: 0.9;
        }
        
        .calculator-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .card-header-icon {
            margin-right: 0.75rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .form-section, .results-section {
            flex: 1;
            min-width: 350px;
        }
        
        .profile-info {
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .profile-info h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .profile-detail {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        
        .profile-detail-label {
            font-weight: bold;
            color: #555;
        }
        
        .profile-detail-value {
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.25);
        }
        
        .input-group {
            display: flex;
            align-items: center;
        }
        
        .input-group-append {
            margin-left: -1px;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #e9ecef;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            color: #555;
            font-weight: bold;
        }
        
        .input-group .form-control {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-right: 0;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 140px;
            max-width: 200px;
        }
        
        .btn:last-child {
            margin-right: 0;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0b7dda;
            box-shadow: 0 4px 8px rgba(30, 144, 255, 0.3);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #4cae4c;
            box-shadow: 0 4px 8px rgba(92, 184, 92, 0.3);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-icon {
            margin-right: 0.5rem;
        }
        
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        /* Results styles */
        .results-section h2, .results-section h3 {
            color: var(--primary-color);
            border-bottom: 2px solid #e29578;
            padding-bottom: 5px;
        }
        
        .results-section dl {
            margin-left: 0;
            padding-left: 0;
        }
        
        .results-section dt {
            font-weight: bold;
            color: #555;
            width: 270px;
            float: left;
            clear: left;
            padding-right: 10px;
        }
        
        .results-section dd {
            margin-left: 280px;
            text-align: right;
            padding-bottom: 5px;
        }
        
        .results-section dl::after {
            content: "";
            display: table;
            clear: both;
        }
        
        .total-line dt, .total-line dd {
            font-weight: bold;
            color: black;
        }
        
        .subtotal-line dt, .subtotal-line dd {
            font-weight: bold;
            color: #333;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }
        
        .igr-line dt, .igr-line dd {
            font-weight: bold;
            color: #c00;
        }
        
        .net-salary {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #eaf4f4;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .info-text {
            font-style: italic;
            color: #444;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .error {
            color: var(--danger-color);
            background-color: #f8d7da;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .flash-messages {
            margin-bottom: 1.5rem;
        }
        
        .flash {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: var(--box-shadow);
        }
        
        .flash-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 5px solid var(--secondary-color);
        }
        
        .flash-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 5px solid var(--danger-color);
        }
        
        .disclaimer {
            font-size: 0.9em;
            color: #666;
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .nav-actions {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 0.8rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .results-section dt {
                width: 100%;
                float: none;
                margin-bottom: 0.25rem;
            }
            
            .results-section dd {
                margin-left: 0;
                padding-left: 1rem;
                border-left: 3px solid #eee;
                margin-bottom: 1rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .btn {
                min-width: 120px;
                max-width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Moroccan Salary Calculator</h1>
        <p class="subtitle">Calculate salary for profile: {{ profile.name }}</p>
    </header>

    <div class="container">
        <!-- Flash Messages -->
        {% if get_flashed_messages() %}
        <div class="flash-messages">
            {% for message in get_flashed_messages() %}
                <div class="flash flash-success">
                    <i class="fas fa-check-circle"></i> {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Navigation Actions -->
        <div class="nav-actions">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-home btn-icon"></i> Home
            </a>
            <a href="{{ url_for('edit_profile', profile_id=profile.id) }}" class="btn btn-primary">
                <i class="fas fa-edit btn-icon"></i> Edit Profile
            </a>
            <a href="{{ url_for('history', profile_id=profile.id) }}" class="btn btn-primary">
                <i class="fas fa-history btn-icon"></i> Calculation History
            </a>
        </div>

        {% if error %}
            <div class="error">
                <i class="fas fa-exclamation-circle"></i> {{ error }}
            </div>
        {% endif %}

        <div class="calculator-container">
            <div class="form-section">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calculator card-header-icon"></i> Salary Calculator
                    </div>
                    <div class="card-body">
                        <!-- Profile Info -->
                        <div class="profile-info">
                            <h3><i class="fas fa-user-circle"></i> Profile Information</h3>
                            <div class="profile-detail">
                                <span class="profile-detail-label">Hourly Rate:</span>
                                <span class="profile-detail-value">{{ "%.2f"|format(profile.hourly_rate) }} MAD</span>
                            </div>
                            {% if profile.function_bonus_base_amount > 0 %}
                            <div class="profile-detail">
                                <span class="profile-detail-label">Function Bonus Base:</span>
                                <span class="profile-detail-value">{{ "%.2f"|format(profile.function_bonus_base_amount) }} MAD</span>
                            </div>
                            {% endif %}
                            {% if profile.performance_bonus_amount > 0 %}
                            <div class="profile-detail">
                                <span class="profile-detail-label">Performance Bonus:</span>
                                <span class="profile-detail-value">{{ "%.2f"|format(profile.performance_bonus_amount) }} MAD</span>
                            </div>
                            {% endif %}
                            {% if profile.prime_de_niveau_amount > 0 %}
                            <div class="profile-detail">
                                <span class="profile-detail-label">Prime de Niveau:</span>
                                <span class="profile-detail-value">{{ "%.2f"|format(profile.prime_de_niveau_amount) }} MAD</span>
                            </div>
                            {% endif %}
                            {% if profile.seniority_rate_percent > 0 %}
                            <div class="profile-detail">
                                <span class="profile-detail-label">Seniority Rate:</span>
                                <span class="profile-detail-value">{{ "%.2f"|format(profile.seniority_rate_percent) }}%</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Input Method Tabs -->
                        <ul class="nav nav-tabs" id="inputMethodTabs" role="tablist" style="margin-bottom: 20px; border-bottom: 1px solid #dee2e6;">
                            <li class="nav-item" role="presentation" style="margin-right: 5px;">
                                <button class="nav-link {{ 'active' if active_tab != 'calendar' else '' }}" id="regular-tab" data-bs-toggle="tab" data-bs-target="#regular-input" type="button" role="tab" aria-controls="regular-input" aria-selected="{{ 'true' if active_tab != 'calendar' else 'false' }}" style="padding: 10px 15px; display: inline-block; border: 1px solid transparent; border-top-left-radius: 5px; border-top-right-radius: 5px; border-color: #dee2e6; border-bottom-color: {{ 'transparent' if active_tab != 'calendar' else '#dee2e6' }}; background-color: {{ '#fff' if active_tab != 'calendar' else '#f8f9fa' }}; cursor: pointer; color: {{ 'var(--primary-color)' if active_tab != 'calendar' else '#495057' }}; font-weight: {{ 'bold' if active_tab != 'calendar' else 'normal' }};">
                                    <i class="fas fa-list-ul"></i> Regular Input
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link {{ 'active' if active_tab == 'calendar' else '' }}" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-input" type="button" role="tab" aria-controls="calendar-input" aria-selected="{{ 'true' if active_tab == 'calendar' else 'false' }}" style="padding: 10px 15px; display: inline-block; border: 1px solid #dee2e6; border-top-left-radius: 5px; border-top-right-radius: 5px; background-color: {{ '#fff' if active_tab == 'calendar' else '#f8f9fa' }}; cursor: pointer; color: {{ 'var(--primary-color)' if active_tab == 'calendar' else '#495057' }}; font-weight: {{ 'bold' if active_tab == 'calendar' else 'normal' }};">
                                    <i class="fas fa-calendar-alt"></i> Calendar Input
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="inputMethodTabsContent">
                            <!-- Regular Input Tab -->
                            <div class="tab-pane fade {{ 'show active' if active_tab != 'calendar' else '' }}" id="regular-input" role="tabpanel" aria-labelledby="regular-tab">
                                <form method="post" id="regularForm">
                                    <input type="hidden" name="input_method" value="regular">
                                    <div class="form-group">
                                        <label for="worked_hours" class="form-label">Worked Hours (This Period):</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="worked_hours" name="worked_hours" value="{{ inputs.get('worked_hours', '') }}" required placeholder="Enter worked hours">
                                            <div class="input-group-append">hours</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="night_hours_worked" class="form-label">Night Hours Worked:</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="night_hours_worked" name="night_hours_worked" value="{{ inputs.get('night_hours_worked', 0) }}" placeholder="0">
                                            <div class="input-group-append">hours</div>
                                        </div>
                                        <small class="help-text">Night hour bonus will be calculated at fixed 20% rate</small>
                                    </div>
                                    
                                    <!-- Extra Hours Fields -->
                                    <div class="form-section-title" style="margin-top: 20px; margin-bottom: 15px; font-size: 1.1rem; color: var(--primary-color); border-bottom: 1px solid var(--primary-color); padding-bottom: 5px;">
                                        <i class="fas fa-business-time"></i> Extra Hours
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="extra_hours_125" class="form-label">Extra Hours (125%):</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="extra_hours_125" name="extra_hours_125" value="{{ inputs.get('extra_hours_125', 0) }}" placeholder="0">
                                            <div class="input-group-append">hours</div>
                                        </div>
                                        <small class="help-text">Compensated at 125% of hourly rate</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="extra_hours_150" class="form-label">Extra Hours (150%):</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="extra_hours_150" name="extra_hours_150" value="{{ inputs.get('extra_hours_150', 0) }}" placeholder="0">
                                            <div class="input-group-append">hours</div>
                                        </div>
                                        <small class="help-text">Compensated at 150% of hourly rate</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="extra_hours_200" class="form-label">Extra Hours (200%):</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="extra_hours_200" name="extra_hours_200" value="{{ inputs.get('extra_hours_200', 0) }}" placeholder="0">
                                            <div class="input-group-append">hours</div>
                                        </div>
                                        <small class="help-text">Compensated at 200% of hourly rate</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="seniority_rate_percent" class="form-label">Seniority (Ancienneté) Rate:</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="seniority_rate_percent" name="seniority_rate_percent" value="{{ inputs.get('seniority_rate_percent', profile.seniority_rate_percent) }}" placeholder="0">
                                            <div class="input-group-append">%</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="paid_leave_days" class="form-label">Paid Leave Days (Congé Payé):</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="paid_leave_days" name="paid_leave_days" value="{{ inputs.get('paid_leave_days', 0) }}" placeholder="0">
                                            <div class="input-group-append">days</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="exceptional_leave_days" class="form-label">Exceptional Leave Days:</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="exceptional_leave_days" name="exceptional_leave_days" value="{{ inputs.get('exceptional_leave_days', 0) }}" placeholder="0">
                                            <div class="input-group-append">days</div>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success btn-block">
                                        <i class="fas fa-calculator btn-icon"></i> Calculate Salary
                                    </button>
                                </form>
                            </div>

                            <!-- Calendar Input Tab -->
                            <div class="tab-pane fade {{ 'show active' if active_tab == 'calendar' else '' }}" id="calendar-input" role="tabpanel" aria-labelledby="calendar-tab">
                                <form method="post" id="calendarForm">
                                    <input type="hidden" name="input_method" value="calendar">
                                    <input type="hidden" id="calendar_data_storage" name="calendar_data_storage" value="{{ inputs.get('calendar_data_storage', '{}') }}">
                                    
                                    <div class="form-group">
                                        <label for="calendar-month" class="form-label">Select Month and Year:</label>
                                        <div class="month-selector" style="display: flex; margin-bottom: 15px; align-items: center;">
                                            <button type="button" id="prev-month-btn" class="btn" style="background-color: var(--primary-color); color: white; border-radius: var(--border-radius) 0 0 var(--border-radius); padding: 8px 12px; border: none;">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <div class="input-group" style="position: relative; flex: 1; margin: 0 -1px;">
                                                <input type="month" class="form-control" id="calendar-month" name="calendar_month" value="{{ inputs.get('calendar_month', '') or current_month }}" required style="padding-right: 40px; border-radius: 0; text-align: center; font-weight: bold;">
                                                <div class="input-group-append" style="position: absolute; right: 0; top: 0; height: 100%; display: flex; align-items: center; padding: 0 10px; color: var(--primary-color);">
                                                    <i class="fas fa-calendar-alt" style="font-size: 1.2rem;"></i>
                                                </div>
                                            </div>
                                            <button type="button" id="next-month-btn" class="btn" style="background-color: var(--primary-color); color: white; border-radius: 0 var(--border-radius) var(--border-radius) 0; padding: 8px 12px; border: none;">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="calendar-controls" style="margin-top: 20px; margin-bottom: 10px;">
                                        <div class="btn-group" style="display: flex; overflow-x: auto; padding-bottom: 10px;">
                                            <button type="button" class="day-type-btn active" data-type="regular" style="flex: 1; background-color: #1a5276; color: white; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-briefcase"></i> Normal Day (7.67h)
                                            </button>
                                            <button type="button" class="day-type-btn" data-type="night" style="flex: 1; background-color: #6c757d; color: white; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-moon"></i> Night Hours
                                            </button>
                                            <button type="button" class="day-type-btn" data-type="extra125" style="flex: 1; background-color: #17a2b8; color: white; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-business-time"></i> Extra (125%)
                                            </button>
                                            <button type="button" class="day-type-btn" data-type="extra150" style="flex: 1; background-color: var(--secondary-color); color: white; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-business-time"></i> Extra (150%)
                                            </button>
                                            <button type="button" class="day-type-btn" data-type="extra200" style="flex: 1; background-color: #9b59b6; color: white; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-business-time"></i> Extra (200%)
                                            </button>
                                            <button type="button" class="day-type-btn" data-type="paid" style="flex: 1; background-color: var(--success-color); color: white; border: none; padding: 8px 12px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-umbrella-beach"></i> Paid Leave
                                            </button>
                                            <button type="button" class="day-type-btn" data-type="exceptional" style="flex: 1; background-color: var(--warning-color); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-home"></i> Except. Leave
                                            </button>
                                        </div>
                                    </div>

                                    <div class="calendar-container" style="margin-top: 20px; border: 1px solid #dee2e6; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow);">
                                        <div class="calendar-header" style="display: flex; background-color: var(--primary-color); color: white; padding: 12px 8px; font-weight: bold;">
                                            <div style="flex: 1; text-align: center;">Mon</div>
                                            <div style="flex: 1; text-align: center;">Tue</div>
                                            <div style="flex: 1; text-align: center;">Wed</div>
                                            <div style="flex: 1; text-align: center;">Thu</div>
                                            <div style="flex: 1; text-align: center;">Fri</div>
                                            <div style="flex: 1; text-align: center; color: #ffcc80;">Sat</div>
                                            <div style="flex: 1; text-align: center; color: #ff9e80;">Sun</div>
                                        </div>
                                        <div id="calendar-days" class="calendar-body" style="display: grid; grid-template-columns: repeat(7, 1fr); grid-gap: 1px; background-color: #dee2e6;">
                                            <!-- Calendar days will be generated by JavaScript -->
                                        </div>
                                    </div>

                                    <!-- Hidden input fields to store calendar data -->
                                    <input type="hidden" id="worked_hours_calendar" name="worked_hours" value="{{ inputs.get('worked_hours', '') }}">
                                    <input type="hidden" id="night_hours_worked_calendar" name="night_hours_worked" value="{{ inputs.get('night_hours_worked', 0) }}">
                                    <input type="hidden" id="extra_hours_125_calendar" name="extra_hours_125" value="{{ inputs.get('extra_hours_125', 0) }}">
                                    <input type="hidden" id="extra_hours_150_calendar" name="extra_hours_150" value="{{ inputs.get('extra_hours_150', 0) }}">
                                    <input type="hidden" id="extra_hours_200_calendar" name="extra_hours_200" value="{{ inputs.get('extra_hours_200', 0) }}">
                                    <input type="hidden" id="paid_leave_days_calendar" name="paid_leave_days" value="{{ inputs.get('paid_leave_days', 0) }}">
                                    <input type="hidden" id="exceptional_leave_days_calendar" name="exceptional_leave_days" value="{{ inputs.get('exceptional_leave_days', 0) }}">
                                    
                                    <!-- Use profile seniority rate -->
                                    <input type="hidden" name="seniority_rate_percent" value="{{ profile.seniority_rate_percent }}">
                                    
                                    <div class="summary-container" style="margin-top: 20px; background-color: var(--light-bg); border-radius: var(--border-radius); padding: 15px;">
                                        <h4 style="margin-top: 0;"><i class="fas fa-list-alt"></i> Summary</h4>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); grid-gap: 10px;">
                                            <div>
                                                <div style="font-weight: bold; color: #1a5276;">Regular Days:</div>
                                                <div id="regular-days-count">0 days (0 hours)</div>
                                            </div>
                                            <div>
                                                <div style="font-weight: bold; color: #6c757d;">Night Hours:</div>
                                                <div id="night-hours-count">0 hours</div>
                                            </div>
                                            <div>
                                                <div style="font-weight: bold; color: #17a2b8;">Extra Hours (125%):</div>
                                                <div id="extra125-hours-count">0 hours</div>
                                            </div>
                                            <div>
                                                <div style="font-weight: bold; color: var(--secondary-color);">Extra Hours (150%):</div>
                                                <div id="extra150-hours-count">0 hours</div>
                                            </div>
                                            <div>
                                                <div style="font-weight: bold; color: #9b59b6;">Extra Hours (200%):</div>
                                                <div id="extra200-hours-count">0 hours</div>
                                            </div>
                                            <div>
                                                <div style="font-weight: bold; color: var(--success-color);">Paid Leave:</div>
                                                <div id="paid-leave-count">0 days</div>
                                            </div>
                                            <div>
                                                <div style="font-weight: bold; color: var(--warning-color);">Exceptional Leave:</div>
                                                <div id="exceptional-leave-count">0 days</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success btn-block" style="margin-top: 20px;">
                                        <i class="fas fa-calculator btn-icon"></i> Calculate Salary
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if results %}
            <div class="results-section">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar card-header-icon"></i> Calculation Results
                    </div>
                    <div class="card-body">
                        <h3>Earnings Breakdown</h3>
                        <dl>
                            {% for name, value in results.earnings.items() %}
                            <dt>{{ name }}:</dt><dd>{{ "%.2f"|format(value) }} MAD</dd>
                            {% endfor %}
                            <hr>
                            <dt class="total-line">Total Gross Salary:</dt><dd class="total-line">{{ "%.2f"|format(results.gross_salary) }} MAD</dd>
                        </dl>

                        <h3>Social & Pension Contributions</h3>
                        <dl>
                            {% for name, value in results.social_pension_contributions.items() %}
                                {% if value != 0 %}
                                    <dt>{{ name }}:</dt><dd>{{ "%.2f"|format(value) }} MAD</dd>
                                {% endif %}
                            {% endfor %}
                            <hr>
                            <dt class="subtotal-line">Total Cotisations:</dt>
                            <dd class="subtotal-line">{{ "%.2f"|format(results.total_social_pension_contributions) }} MAD</dd>
                        </dl>

                        <h3>Income Tax (IGR)</h3>
                        <dl>
                            <dt class="igr-line">IGR (Income Tax - calc. 0 dependents):</dt>
                            <dd class="igr-line">{{ "%.2f"|format(results.igr_calculation_details['IGR (Income Tax - calc. 0 dependents)']) }} MAD</dd>
                        </dl>
                        
                        <p class="info-text">
                            (Calculated based on SNI: {{ "%.2f"|format(results.igr_calculation_details['Net Taxable Income (SNI - Monthly)']) }} MAD,
                            after Prof. Expenses Deduction: {{ "%.2f"|format(results.igr_calculation_details['Professional Expenses Deduction (Info)']) }} MAD)
                        </p>

                        <div class="net-salary">
                            Net Salary to Pay: {{ "%.2f"|format(results.net_salary) }} MAD
                        </div>

                        <div class="disclaimer">
                            <strong>Disclaimer:</strong> This calculation is an estimate based on the provided inputs and standard Moroccan regulations (including common social contribution structures). The IGR (Income Tax) calculation assumes 0 dependents and does not apply family charge deductions; actual tax may be lower for users with dependents. Actual net salary may differ due to specific company policies, variations in complementary insurance schemes, payroll system rounding, specific IGR adjustments, or recent changes in law not yet reflected here. Always refer to your official payslip for definitive figures.
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</body>

<script>
    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-pane');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all tabs and tab contents
                tabs.forEach(t => t.classList.remove('active'));
                tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
                tabContents.forEach(c => {
                    c.classList.remove('show');
                    c.classList.remove('active');
                });
                
                // Add active class to clicked tab and its content
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                const targetId = this.getAttribute('data-bs-target').substring(1);
                document.getElementById(targetId).classList.add('show');
                document.getElementById(targetId).classList.add('active');
            });
        });
        
        // Calendar functionality
        let selectedDayType = 'regular';
        const dayTypeButtons = document.querySelectorAll('.day-type-btn');
        
        // Day type button styling and selection
        dayTypeButtons.forEach(button => {
            button.addEventListener('click', function() {
                dayTypeButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                selectedDayType = this.getAttribute('data-type');
            });
        });
        
        // Calendar generation
        const calendarMonth = document.getElementById('calendar-month');
        const calendarDays = document.getElementById('calendar-days');
        
        // Standard hours per day
        const STANDARD_HOURS_PER_DAY = 7.67;
        
        // Initialize calendar data structure
        let calendarData = {};
        
        // Load stored calendar data if available
        function loadCalendarData() {
            const storedData = document.getElementById('calendar_data_storage').value;
            if (storedData && storedData !== '{}') {
                try {
                    calendarData = JSON.parse(storedData);
                } catch (e) {
                    console.error('Error parsing stored calendar data:', e);
                    calendarData = {};
                }
            }
        }
        
        // Save calendar data to the form for submission
        function saveCalendarData() {
            document.getElementById('calendar_data_storage').value = JSON.stringify(calendarData);
        }
        
        function generateCalendar() {
            const selectedDate = calendarMonth.value ? new Date(calendarMonth.value + '-01') : new Date();
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            
            // Update month display in header if we have a header element
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const monthYearHeader = document.getElementById('month-year-display');
            if (monthYearHeader) {
                monthYearHeader.textContent = `${monthNames[month]} ${year}`;
            }
            
            // Clear previous calendar
            calendarDays.innerHTML = '';
            
            // Initialize calendar data for this month if not exists
            const monthKey = `${year}-${month+1}`;
            if (!calendarData[monthKey]) {
                calendarData[monthKey] = {};
            }
            
            // Get first day of month and last day
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Calculate the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
            // Convert Sunday (0) to 6 and others by subtracting 1 (Monday=0, Tuesday=1, etc.)
            const startingDayOfWeek = (firstDay.getDay() + 6) % 7;
            
            // Fill in leading empty cells
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                emptyCell.style.backgroundColor = '#f8f9fa';
                emptyCell.style.minHeight = '85px';
                emptyCell.style.border = '1px solid #f0f0f0';
                calendarDays.appendChild(emptyCell);
            }
            
            // Create day cells
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const cell = createDayCell(day, year, month);
                
                // Check if this day has data
                const dayKey = `${year}-${month+1}-${day}`;
                if (calendarData[monthKey][day]) {
                    const dayData = calendarData[monthKey][day];
                    colorCell(cell, dayData.type);
                    cell.setAttribute('data-selected', 'true');
                    
                    // Add info label
                    const infoLabel = document.createElement('div');
                    infoLabel.style.position = 'absolute';
                    infoLabel.style.bottom = '5px';
                    infoLabel.style.left = '5px';
                    infoLabel.style.right = '5px';
                    infoLabel.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                    infoLabel.style.padding = '3px 5px';
                    infoLabel.style.borderRadius = '4px';
                    infoLabel.style.fontSize = '0.8rem';
                    infoLabel.style.fontWeight = 'bold';
                    infoLabel.style.textAlign = 'center';
                    infoLabel.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                    
                    switch(dayData.type) {
                        case 'regular':
                            infoLabel.textContent = `Regular (${STANDARD_HOURS_PER_DAY}h)`;
                            infoLabel.style.color = '#1a5276';
                            break;
                        case 'night':
                            infoLabel.textContent = `Night (${dayData.hours}h)`;
                            infoLabel.style.color = '#6c757d';
                            break;
                        case 'extra125':
                            infoLabel.textContent = `125% (${STANDARD_HOURS_PER_DAY}h)`;
                            infoLabel.style.color = '#17a2b8';
                            break;
                        case 'extra150':
                            infoLabel.textContent = `150% (${STANDARD_HOURS_PER_DAY}h)`;
                            infoLabel.style.color = 'var(--secondary-color)';
                            break;
                        case 'extra200':
                            infoLabel.textContent = `200% (${STANDARD_HOURS_PER_DAY}h)`;
                            infoLabel.style.color = '#9b59b6';
                            break;
                        case 'paid':
                            infoLabel.textContent = `Paid Leave`;
                            infoLabel.style.color = 'var(--success-color)';
                            break;
                        case 'exceptional':
                            infoLabel.textContent = `Except. Leave`;
                            infoLabel.style.color = 'var(--warning-color)';
                            break;
                    }
                    
                    cell.appendChild(infoLabel);
                }
                
                // Day click event
                cell.addEventListener('click', function() {
                    handleDayClick(year, month, day);
                });
                
                calendarDays.appendChild(cell);
            }
            
            updateSummary();
        }
        
        function colorCell(cell, type) {
            // Set background color based on day type - using more vibrant colors that match button colors exactly
            switch(type) {
                case 'regular':
                    cell.style.backgroundColor = '#1a5276'; // Darker blue for regular days
                    cell.style.color = 'white'; // Better text contrast
                    break;
                case 'night':
                    cell.style.backgroundColor = '#6c757d'; // Match the night hours button
                    cell.style.color = 'white';
                    break;
                case 'extra125':
                    cell.style.backgroundColor = '#17a2b8'; // Match the extra 125% button
                    cell.style.color = 'white';
                    break;
                case 'extra150':
                    cell.style.backgroundColor = 'var(--secondary-color)'; // Match the extra 150% button
                    cell.style.color = 'white';
                    break;
                case 'extra200':
                    cell.style.backgroundColor = '#9b59b6'; // Purple for 200% extra hours
                    cell.style.color = 'white';
                    break;
                case 'paid':
                    cell.style.backgroundColor = 'var(--success-color)'; // Match the paid leave button
                    cell.style.color = 'white';
                    break;
                case 'exceptional':
                    cell.style.backgroundColor = 'var(--warning-color)'; // Match the exceptional leave button
                    cell.style.color = 'white';
                    break;
                default:
                    cell.style.backgroundColor = '#fff';
                    cell.style.color = 'black';
            }
            // Add subtle border and shadow to selected cells
            cell.style.border = '1px solid rgba(0,0,0,0.1)';
            cell.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        }
        
        function handleDayClick(year, month, day) {
            const monthKey = `${year}-${month+1}`;
            
            // Initialize month data if not exists
            if (!calendarData[monthKey]) {
                calendarData[monthKey] = {};
            }
            
            // Toggle day data
            if (calendarData[monthKey][day] && calendarData[monthKey][day].type === selectedDayType) {
                // Remove the day if it's the same type
                delete calendarData[monthKey][day];
            } else {
                // Add/update day with the selected type
                let hours = STANDARD_HOURS_PER_DAY;
                
                // For night hours only, prompt for hours - extra hours are now full days
                if (selectedDayType === 'night') {
                    const promptHours = prompt(`Enter the number of night hours for this day:`, "");
                    if (promptHours === null) return; // User cancelled
                    
                    hours = parseFloat(promptHours);
                    if (isNaN(hours) || hours <= 0) {
                        alert('Please enter a valid number of hours greater than 0.');
                        return;
                    }
                }
                
                calendarData[monthKey][day] = {
                    type: selectedDayType,
                    hours: hours
                };
            }
            
            // Save calendar data for form submission
            saveCalendarData();
            
            // Regenerate calendar to show changes
            generateCalendar();
            updateInputFields();
        }
        
        function updateSummary() {
            // Initialize counters
            let regularDays = 0;
            let nightHours = 0;
            let extraHours125 = 0;
            let extraHours150 = 0;
            let extraHours200 = 0;
            let paidLeaveDays = 0;
            let exceptionalLeaveDays = 0;
            
            // Get current month data
            const selectedDate = calendarMonth.value ? new Date(calendarMonth.value + '-01') : new Date();
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const monthKey = `${year}-${month+1}`;
            
            if (calendarData[monthKey]) {
                // Count each type of day
                for (const day in calendarData[monthKey]) {
                    const dayData = calendarData[monthKey][day];
                    
                    switch(dayData.type) {
                        case 'regular':
                            regularDays++;
                            break;
                        case 'night':
                            nightHours += dayData.hours;
                            break;
                        case 'extra125':
                            extraHours125 += dayData.hours;
                            break;
                        case 'extra150':
                            extraHours150 += dayData.hours;
                            break;
                        case 'extra200':
                            extraHours200 += dayData.hours;
                            break;
                        case 'paid':
                            paidLeaveDays++;
                            break;
                        case 'exceptional':
                            exceptionalLeaveDays++;
                            break;
                    }
                }
            }
            
            // Update summary display
            document.getElementById('regular-days-count').textContent = `${regularDays} days (${(regularDays * STANDARD_HOURS_PER_DAY).toFixed(2)} hours)`;
            document.getElementById('night-hours-count').textContent = `${nightHours.toFixed(2)} hours`;
            document.getElementById('extra125-hours-count').textContent = `${extraHours125.toFixed(2)} hours`;
            document.getElementById('extra150-hours-count').textContent = `${extraHours150.toFixed(2)} hours`;
            document.getElementById('extra200-hours-count').textContent = `${extraHours200.toFixed(2)} hours`;
            document.getElementById('paid-leave-count').textContent = `${paidLeaveDays} days`;
            document.getElementById('exceptional-leave-count').textContent = `${exceptionalLeaveDays} days`;
        }
        
        function updateInputFields() {
            // Get current month data
            const selectedDate = calendarMonth.value ? new Date(calendarMonth.value + '-01') : new Date();
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const monthKey = `${year}-${month+1}`;
            
            // Initialize counters
            let regularDays = 0;
            let nightHours = 0;
            let extraHours125 = 0;
            let extraHours150 = 0;
            let extraHours200 = 0;
            let paidLeaveDays = 0;
            let exceptionalLeaveDays = 0;
            
            if (calendarData[monthKey]) {
                // Count each type of day
                for (const day in calendarData[monthKey]) {
                    const dayData = calendarData[monthKey][day];
                    
                    switch(dayData.type) {
                        case 'regular':
                            regularDays++;
                            break;
                        case 'night':
                            nightHours += dayData.hours;
                            break;
                        case 'extra125':
                            extraHours125 += dayData.hours;
                            break;
                        case 'extra150':
                            extraHours150 += dayData.hours;
                            break;
                        case 'extra200':
                            extraHours200 += dayData.hours;
                            break;
                        case 'paid':
                            paidLeaveDays++;
                            break;
                        case 'exceptional':
                            exceptionalLeaveDays++;
                            break;
                    }
                }
            }
            
            // Update hidden input fields
            document.getElementById('worked_hours_calendar').value = (regularDays * STANDARD_HOURS_PER_DAY).toFixed(2);
            document.getElementById('night_hours_worked_calendar').value = nightHours.toFixed(2);
            document.getElementById('extra_hours_125_calendar').value = extraHours125.toFixed(2);
            document.getElementById('extra_hours_150_calendar').value = extraHours150.toFixed(2);
            document.getElementById('extra_hours_200_calendar').value = extraHours200.toFixed(2);
            document.getElementById('paid_leave_days_calendar').value = paidLeaveDays;
            document.getElementById('exceptional_leave_days_calendar').value = exceptionalLeaveDays;
        }
        
        // Function to create a day cell
        function createDayCell(day, year, month) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            
            // Style the cell
            cell.style.backgroundColor = '#fff';
            cell.style.padding = '5px';
            cell.style.minHeight = '85px';
            cell.style.position = 'relative';
            cell.style.border = '1px solid #f0f0f0';
            cell.style.transition = 'all 0.2s ease';
            
            // Make weekends slightly different color
            const dayOfWeek = new Date(year, month, day).getDay();
            if (dayOfWeek === 0) { // Sunday
                cell.style.backgroundColor = '#fff5f5';
            } else if (dayOfWeek === 6) { // Saturday
                cell.style.backgroundColor = '#f8f9fa';
            }
            
            // Add day number with styled container
            const dayNumber = document.createElement('div');
            dayNumber.textContent = day;
            dayNumber.style.position = 'absolute';
            dayNumber.style.top = '5px';
            dayNumber.style.left = '5px';
            dayNumber.style.fontWeight = 'bold';
            dayNumber.style.backgroundColor = 'rgba(255,255,255,0.7)';
            dayNumber.style.borderRadius = '50%';
            dayNumber.style.width = '24px';
            dayNumber.style.height = '24px';
            dayNumber.style.display = 'flex';
            dayNumber.style.alignItems = 'center';
            dayNumber.style.justifyContent = 'center';
            
            cell.appendChild(dayNumber);
            
            // Add hover effect
            cell.addEventListener('mouseenter', function() {
                if (!cell.hasAttribute('data-selected')) {
                    cell.style.backgroundColor = '#e6f2ff';
                    cell.style.cursor = 'pointer';
                }
            });
            
            cell.addEventListener('mouseleave', function() {
                if (!cell.hasAttribute('data-selected')) {
                    if (dayOfWeek === 0) { // Sunday
                        cell.style.backgroundColor = '#fff5f5';
                    } else if (dayOfWeek === 6) { // Saturday
                        cell.style.backgroundColor = '#f8f9fa';
                    } else {
                        cell.style.backgroundColor = '#fff';
                    }
                }
            });
            
            return cell;
        }
        
        // Initialize calendar and event listeners
        if (calendarMonth) {
            calendarMonth.addEventListener('change', generateCalendar);
            
            // Add event listeners for month navigation buttons
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', function() {
                    const currentDate = calendarMonth.value ? new Date(calendarMonth.value + '-01') : new Date();
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    calendarMonth.value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                    generateCalendar();
                });
            }
            
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', function() {
                    const selectedDate = calendarMonth.value ? new Date(calendarMonth.value + '-01') : new Date();
                    selectedDate.setMonth(selectedDate.getMonth() + 1);
                    calendarMonth.value = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}`;
                    generateCalendar();
                });
            }
            
            // Load saved calendar data if available
            loadCalendarData();
            
            generateCalendar();
            
            // Set active tab based on server parameter
            if ('{{ active_tab }}' === 'calendar') {
                document.getElementById('calendar-tab').click();
            }
            
            // Add form submit event listeners
            document.getElementById('calendarForm').addEventListener('submit', function() {
                // Save calendar data before submitting
                saveCalendarData();
                
                // Set a parameter to indicate we should return to the calendar tab
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'tab';
                input.value = 'calendar';
                this.appendChild(input);
            });
            
            // Add tab parameter to regular form too
            document.getElementById('regularForm').addEventListener('submit', function() {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'tab';
                input.value = 'regular';
                this.appendChild(input);
            });
        }
    });
</script>
</html> 